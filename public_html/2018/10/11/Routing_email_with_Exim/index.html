<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Routing email with Exim · Chocolate + Mint</title><meta name="description" content="Routing email with Exim - mint = Nguyen Duc Tin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://chocomint.co/atom.xml" title="Chocolate + Mint"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">Chocolate + Mint</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Routing email with Exim</h1><div class="post-info">Oct 11, 2018</div><div class="post-content"><p>Exim là một cung cụ MTA mạnh mẽ, cho phép chúng ta thực hiện gửi và nhận mail </p>
<h1 id="Tong-quan-qua-trinh-routing-email-va-transport-cua-Exim"><a href="#Tong-quan-qua-trinh-routing-email-va-transport-cua-Exim" class="headerlink" title="Tổng quan quá trình routing email và transport của Exim"></a>Tổng quan quá trình routing email và transport của Exim</h1><p>Đầu tiên, Exim sẽ phân biệt nơi cần gửi email tới dựa trên địa chỉ của người nhận. Exim sẽ phân loại ra 2 dạng địa chỉ là: </p>
<ul>
<li><code>Local address</code> - email sẽ được gửi tại localhost, các địa chỉ này đã tồn tại trên máy chủ (bằng file_append hoặc pipe_append)</li>
<li><code>Remote address</code> - email sẽ được gửi tới 1 host khác bằng giao thức SMTP</li>
</ul>
<p>Sau đó Exim sẽ lookup địa chỉ trong config của nó, nếu như hợp điều kiện nào đầu tiên, Exim sẽ sử dụng Routing đó cho việc gửi mail, nếu không trùng bất cứ điều kiện nào, Exim sẽ đưa email vào queue với trạng thái là <code>Unrouteable Address</code></p>
<p>Sau khi địa chỉ đã tìm được Routing của đời mình, Routing đó sẽ sử dụng Transport config để đẩy email đi. </p>
<p><img src="/images/routing_transport.png" alt="Email_Routing_Transport"></p>
<h2 id="Routing-local"><a href="#Routing-local" class="headerlink" title="Routing local"></a>Routing local</h2><p>Danh sách các domain được định nghĩa là local được định nghĩe trong file congig của Exim:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">domainlist local_domains = lsearch;/etc/virtual/domains</span><br></pre></td></tr></table></figure>
<p>-&gt; tất cả các domain có trong file <code>/etc/virtual/domains</code> sẽ được gửi vào local_address</p>
<p>Sau khi đã xác nhận được địa chỉ gửi nằm trong localhost, việc gửi mail cho các địa chỉ local tiếp túc được phân loại bởi block config Directors, tại đây Exim sẽ xác nhận rằng địa chỉ nhận tới có tồn tại trong danh sách User mà nó biết hay không, sau đó sẽ ghi nội dung email tới hòm thư của User đó hoặc chuyển tiếp vào pipe hay Alias tương ứng.</p>
<p>  <code>pipe_transport</code> là phương thức gửi mail bằng cách chuyển tiếp email đó sử dụng command trên hệ thống, nó như kiểu pipeline chúng ta hay sử dụng trên Shell ấy.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_transport | /usr/local/bin/procmail -d $local_part</span><br></pre></td></tr></table></figure>
<p>Ví dụ 1 block config của Exim, <code>driver</code> là gì: driver là định nghĩa thuộc tính hoạt động của một block code trong Exim, các config trong Exim được chia thành các block và mỗi 1 block sẽ có 1 định nghĩa driver, giống như là khai báo thuộc tính của 1 biến, int, var, char, float ..v.v</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virtual_localdelivery:</span><br><span class="line">  driver = appendfile </span><br><span class="line">  file = /path/to/mail/file</span><br></pre></td></tr></table></figure>
<p>Driver định nghĩa là sẽ ghi vào file, vậy nên trong block config này sẽ kèm theo một số cấu hình nữa liên quan đến việc ghi email vào file.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virtual_address_pipe:</span><br><span class="line">  driver = pipe</span><br><span class="line">  command = /usr/local/bin/command $host $local_part</span><br></pre></td></tr></table></figure></p>
<p>Còn đối với block này thì lại truyền email qua pipeline, cấu hình sẽ khác đi 1 chút. Lưu ý các cấu hình trên chỉ mang tính chất minh họa cho dễ hiểu :D</p>
<h3 id="Routing-to-remote-host"><a href="#Routing-to-remote-host" class="headerlink" title="Routing to remote host"></a>Routing to remote host</h3><p>Đối với các <code>remote_address</code>, block Routers sẽ quản lý cách các email này được gửi, cụ thể là Transport nào tương ứng.</p>
<p>Tại mỗi Route của exim, chúng ta sẽ định nghĩa cho Transport nào sẽ quản lý cách thức mà email sẽ được gửi đi, đối với các địa chỉ local thì thường sẽ dùng phương thức ghi vào file mailbox của user . <code>pipe_transport</code> là phương thức gửi mail bằng cách chuyển tiếp email đó sử dụng command trên hệ thống, nó như kiểu pipeline chúng ta hay sử dụng trên Shell ấy. </p>
<h5 id="Remote-transport-with-SMTP"><a href="#Remote-transport-with-SMTP" class="headerlink" title="Remote transport with SMTP"></a>Remote transport with SMTP</h5><p>Lookup SMTP khi dùng nhiều tài khoản SMTP </p>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2018/05/21/How-to-corrupt-and-repair-bootloader-MBR/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 <a href="https://chocomint.co">mint = Nguyen Duc Tin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>