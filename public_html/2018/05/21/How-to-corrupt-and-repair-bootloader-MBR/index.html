<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> How to corrupt and repair bootloader · Chocolate + Mint</title><meta name="description" content="How to corrupt and repair bootloader - mint = Nguyen Duc Tin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://chocomint.co/atom.xml" title="Chocolate + Mint"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">Chocolate + Mint</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">How to corrupt and repair bootloader</h1><div class="post-info">May 21, 2018</div><div class="post-content"><h1 id="How-to-corrupt-and-repair-bootloader"><a href="#How-to-corrupt-and-repair-bootloader" class="headerlink" title="How to corrupt and repair bootloader"></a><strong>How to corrupt and repair bootloader</strong></h1><p>Xin chào, mình là Mint,</p>
<p>Hôm nay chúng ta sẽ cùng thực hành phá hỏng booloader, sau đó sẽ tạo lại bootloader bằng grub</p>
<p><strong>Let’s do it</strong>  </p>
<h2 id="Xoa-du-lieu-tren-MBR"><a href="#Xoa-du-lieu-tren-MBR" class="headerlink" title="Xóa dữ liệu trên MBR"></a><strong>Xóa dữ liệu trên MBR</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# dd if=/dev/zero of=/dev/sda bs=446 count=1</span><br></pre></td></tr></table></figure>
<p><em>Boot sector có độ dài 512 bytes, trong đó 446 bytes đầu tiên là bootloader code, phần còn lại sẽ là partition table, chúng ta sẽ chỉ ghi đè 446 bytes đầu tiên mà thôi</em></p>
<blockquote>
<p>0x0000 to 0x01BD - First 446 bytes (boot loader code)<br>0x01BE to 0x01CD - Partition entry 1<br>0x01CE to 0x01DD - Partition entry 2<br>0x01DE to 0x01ED - Partition entry 3<br>0x01EE to 0x01FD - Partition entry 4<br>0x01FE to 0x01FF - Boot signature (55 AA)</p>
</blockquote>
<p>Reboot và tận hưởng </p>
<h2 id="Rescure-he-thong"><a href="#Rescure-he-thong" class="headerlink" title="Rescure hệ thống"></a><strong>Rescure hệ thống</strong></h2><ul>
<li>Enter rescure mode</li>
</ul>
<p>Khi sử dụng liveCD, CentOS có chế độ tự động phát hiện hệ điều hành cài đặt trên ổ cứng, tự động mount những phân vùng cần thiết để có 1 hệ thống hoàn chỉnh. Nếu sử dụng các distro khác hoặc hệ thống không tự động mount được, chúng ta sẽ phải mount bằng tay </p>
<p>Start <strong>shell</strong> </p>
<p>Tạo 1 thư mục để mount hệ thống<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /mnt/centos</span><br></pre></td></tr></table></figure></p>
<p>Sử dụng <code>fdisk</code> để kiểm tra xem các partition được cài đặt như thế nào</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# fdisk /dev/sda</span><br><span class="line"></span><br><span class="line">p</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    16777215     7339008   8e  Linux LVM</span><br></pre></td></tr></table></figure>
<p>Như vậy, <code>/dev/sda1</code> là phân vùng boot của hệ thống, <code>/dev/sda2</code> là phần còn lại <code>/</code><br>Trong trường hợp có nhiều partition hơn, chúng ta thực hiện mount các partition này vào các thư mục để xác định lần lượt các mountpoint, quan trọng là root <code>/</code> , hệ thống có thể có thêm <code>/home</code>, <code>/var</code>, <code>/blabla</code>. Xem file <code>/etc/fstab</code> để xác định.</p>
<p>Đối với Standard partition table, chúng ta có thể mount bằng lệnh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# mount /dev/sda2 /mnt/centos</span><br></pre></td></tr></table></figure></p>
<p>Đối với hệ thống sử dụng partition dạng LVM như trong bài lab này, sẽ tốn thêm 1 vài bước nữa </p>
<p>Xác định Volume Group  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# pvscan </span><br><span class="line">  PV /dev/sda2   VG centos          lvm2 [&lt;7.00 GiB / 0    free]</span><br><span class="line">  Total: 1 [&lt;7.00 GiB] / in use: 1 [&lt;7.00 GiB] / in no VG: 0 [0   ]</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# lvscan </span><br><span class="line">  inactive            &apos;/dev/centos/swap&apos; [820.00 MiB] inherit</span><br><span class="line">  inactive            &apos;/dev/centos/root&apos; [&lt;6.20 GiB] inherit</span><br></pre></td></tr></table></figure>
<p>Do volume <code>/dev/centos/root</code> chưa active nên ta active trước khi mount </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vgchange -a y /dev/centos/root</span><br></pre></td></tr></table></figure>
<p>Tiếp theo là mount partition sử dụng lệnh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# mount /dev/centos/root /mnt/centos</span><br></pre></td></tr></table></figure>
<p>Vì <code>/boot</code> sử dụng định dạng Standard nên ta có thể mount dễ dàng bằng </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# mount /dev/sda1 /mnt/centos/boot</span><br></pre></td></tr></table></figure>
<p>Tiếp theo là mount <code>/dev</code>, <code>/proc</code>, <code>/sys</code> vào hệ thống mới </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@localhost ~]# mount -t proc /proc /mnt/centos/proc</span><br><span class="line">[root@localhost ~]# mount -t sysfs /sys /mnt/centos/sys</span><br><span class="line">[root@localhost ~]# mount -o bind /dev /mnt/centos/dev</span><br></pre></td></tr></table></figure>
<p>Change root system </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chroot /mnt/centos</span><br></pre></td></tr></table></figure>
<p>Reinstall GRUB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# grub2-install /dev/sda</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hoặc grub-install, dành cho Grub verison 1</p>
</blockquote>
<p>Exit và reboot </p>
<p><em>PS:// Nếu test trên VirtualBox hoặc KVM thì phải gỡ LiveCD ra sau khi reboot nhé, VirtualBox hiện tại bị bug chain-load <a href="https://www.virtualbox.org/ticket/2680" target="_blank" rel="noopener">Ticket 2680</a> </em></p>
<p>Xin chào and peace out!</p>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2018/10/11/Routing_email_with_Exim/" class="prev">PREV</a></div><div class="copyright"><p>© 2018 <a href="https://chocomint.co">mint = Nguyen Duc Tin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>